# Earthquake System Testing Guide

## Overview

This comprehensive testing guide covers all aspects of the earthquake monitoring system, from unit tests to end-to-end integration testing. It ensures the system works reliably in production.

## Testing Strategy

### Test Pyramid

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   E2E Tests     â”‚ (Few)
                    â”‚ Full Integrationâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Integration Tests    â”‚ (Some)
                  â”‚ API, Database, FCM    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚        Unit Tests               â”‚ (Many)
              â”‚ Functions, Services, Utilities  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Test Categories

1. **Unit Tests**: Individual functions and services
2. **Integration Tests**: API endpoints, database operations, FCM
3. **End-to-End Tests**: Complete earthquake detection flow
4. **Performance Tests**: Load testing and scalability
5. **Manual Tests**: User interface and experience

## Unit Tests

### 1. USGS API Service Tests

**tests/services/usgs.test.ts**

```typescript
import { assertEquals, assertThrows } from 'https://deno.land/std@0.168.0/testing/asserts.ts';
import { USGSService } from '../../services/usgs.ts';

Deno.test('USGSService - should fetch earthquake data successfully', async () => {
  const data = await USGSService.fetchEarthquakeData();

  assertEquals(data.type, 'FeatureCollection');
  assertEquals(typeof data.metadata.count, 'number');
  assertEquals(Array.isArray(data.features), true);
});

Deno.test('USGSService - should handle API errors gracefully', async () => {
  // Mock fetch to return error
  const originalFetch = globalThis.fetch;
  globalThis.fetch = () => Promise.resolve(new Response('', { status: 500 }));

  await assertThrows(() => USGSService.fetchEarthquakeData(), Error, 'USGS API request failed: 500');

  // Restore original fetch
  globalThis.fetch = originalFetch;
});

Deno.test('USGSService - should validate response format', async () => {
  // Mock fetch to return invalid data
  const originalFetch = globalThis.fetch;
  globalThis.fetch = () => Promise.resolve(new Response(JSON.stringify({})));

  await assertThrows(() => USGSService.fetchEarthquakeData(), Error, 'Invalid response format from USGS API');

  globalThis.fetch = originalFetch;
});
```

### 2. Notification Formatting Tests

**tests/utils/notification.test.ts**

````typescript
import { assertEquals } from 'https://deno.land/std@0.168.0/testing/asserts.ts';
import { formatNotification, classifyEarthquakeSeverity } from '../../utils/notification.ts';

const mockEarthquake = {
  id: 'us6000test',
  type: 'Feature' as const,
  properties: {
    mag: 4.6,
    place: '6 km NW of Test City, Philippines',
    time: 1763373268186,
    updated: 1763387967040,
    url: 'https://earthquake.usgs.gov/earthquakes/eventpage/us6000test',
    tsunami: 0,
    status: 'reviewed',
    title: 'M 4.6 - 6 km NW of Test City, Philippines'
  },
  geometry: {
    type: 'Point' as const,
    coordinates: [120.8377, 13.7424, 146.927] as [number, number, number]
  }
};\n\nDeno.test('formatNotification - should format notification correctly', () => {\n  const notification = formatNotification(mockEarthquake);\n  \n  assertEquals(notification.earthquakeId, 'us6000test');\n  assertEquals(notification.magnitude, 4.6);\n  assertEquals(notification.location, '6 km NW of Test City, Philippines');\n  assertEquals(notification.severity, 'light');\n  assertEquals(notification.priority, 'normal');\n  assertEquals(notification.tsunamiWarning, false);\n});\n\nDeno.test('classifyEarthquakeSeverity - should classify magnitudes correctly', () => {\n  assertEquals(classifyEarthquakeSeverity(1.5), 'micro');\n  assertEquals(classifyEarthquakeSeverity(2.5), 'minor');\n  assertEquals(classifyEarthquakeSeverity(3.5), 'minor');\n  assertEquals(classifyEarthquakeSeverity(4.5), 'light');\n  assertEquals(classifyEarthquakeSeverity(5.5), 'moderate');\n  assertEquals(classifyEarthquakeSeverity(6.5), 'strong');\n  assertEquals(classifyEarthquakeSeverity(7.5), 'major');\n  assertEquals(classifyEarthquakeSeverity(8.5), 'great');\n});\n\nDeno.test('formatNotification - should handle tsunami warnings', () => {\n  const tsunamiEarthquake = {\n    ...mockEarthquake,\n    properties: {\n      ...mockEarthquake.properties,\n      tsunami: 1\n    }\n  };\n  \n  const notification = formatNotification(tsunamiEarthquake);\n  assertEquals(notification.tsunamiWarning, true);\n});\n```\n\n### 3. Data Comparison Tests\n\n**tests/utils/comparison.test.ts**\n\n```typescript\nimport { assertEquals } from 'https://deno.land/std@0.168.0/testing/asserts.ts';\nimport { compareEarthquakeData } from '../../utils/comparison.ts';\n\nconst existingEarthquakes = [\n  { id: 'us6000old1' },\n  { id: 'us6000old2' },\n  { id: 'us6000old3' }\n];\n\nconst newUSGSData = [\n  { id: 'us6000old1', properties: { mag: 3.2 } }, // Existing\n  { id: 'us6000new1', properties: { mag: 4.1 } }, // New\n  { id: 'us6000old2', properties: { mag: 2.8 } }, // Existing\n  { id: 'us6000new2', properties: { mag: 5.3 } }  // New\n];\n\nDeno.test('compareEarthquakeData - should identify new earthquakes', () => {\n  const newEarthquakes = compareEarthquakeData(newUSGSData, existingEarthquakes);\n  \n  assertEquals(newEarthquakes.length, 2);\n  assertEquals(newEarthquakes[0].id, 'us6000new1');\n  assertEquals(newEarthquakes[1].id, 'us6000new2');\n});\n\nDeno.test('compareEarthquakeData - should return empty array when no new earthquakes', () => {\n  const onlyExistingData = [\n    { id: 'us6000old1', properties: { mag: 3.2 } },\n    { id: 'us6000old2', properties: { mag: 2.8 } }\n  ];\n  \n  const newEarthquakes = compareEarthquakeData(onlyExistingData, existingEarthquakes);\n  assertEquals(newEarthquakes.length, 0);\n});\n\nDeno.test('compareEarthquakeData - should handle empty existing data', () => {\n  const newEarthquakes = compareEarthquakeData(newUSGSData, []);\n  assertEquals(newEarthquakes.length, 4); // All are new\n});\n```\n\n## Integration Tests\n\n### 1. Firestore Integration Tests\n\n**tests/integration/firestore.test.ts**\n\n```typescript\nimport { assertEquals } from 'https://deno.land/std@0.168.0/testing/asserts.ts';\nimport { FirestoreService } from '../../services/firestore.ts';\n\n// Mock earthquake data for testing\nconst mockEarthquake = {\n  id: 'test123',\n  magnitude: 4.5,\n  place: 'Test Location',\n  time: Date.now(),\n  coordinates: { longitude: 120.0, latitude: 14.0, depth: 10.0 },\n  properties: { mag: 4.5, place: 'Test Location' },\n  created_at: Date.now(),\n  updated_at: Date.now(),\n  severity_level: 'light',\n  notification_sent: true\n};\n\nDeno.test('FirestoreService - should save earthquake data', async () => {\n  await FirestoreService.saveNewEarthquakes([mockEarthquake]);\n  \n  const saved = await FirestoreService.getExistingEarthquakes();\n  const found = saved.find(eq => eq.id === 'test123');\n  \n  assertEquals(found !== undefined, true);\n});\n\nDeno.test('FirestoreService - should retrieve existing earthquakes', async () => {\n  const earthquakes = await FirestoreService.getExistingEarthquakes();\n  \n  assertEquals(Array.isArray(earthquakes), true);\n  \n  if (earthquakes.length > 0) {\n    assertEquals(typeof earthquakes[0].id, 'string');\n  }\n});\n\nDeno.test('FirestoreService - should save notification records', async () => {\n  const mockNotifications = [{\n    earthquake_id: 'test123',\n    type: 'earthquake_alert',\n    title: 'Test Alert',\n    magnitude: 4.5\n  }];\n  \n  await FirestoreService.saveNotificationRecords(mockNotifications);\n  \n  // Verify notification was saved (implementation depends on your query method)\n  // const notifications = await FirestoreService.getNotifications();\n  // assertEquals(notifications.length > 0, true);\n});\n```\n\n### 2. FCM Integration Tests\n\n**tests/integration/fcm.test.ts**\n\n```typescript\nimport { assertEquals, assertExists } from 'https://deno.land/std@0.168.0/testing/asserts.ts';\nimport { FCMService } from '../../services/fcm.ts';\n\nconst testNotification = {\n  earthquakeId: 'test123',\n  magnitude: 4.5,\n  location: 'Test Location, Philippines',\n  coordinates: { latitude: 14.0, longitude: 120.0, depth: 10.0 },\n  time: Date.now(),\n  severity: 'light' as const,\n  priority: 'normal' as const,\n  tsunamiWarning: false,\n  usgsUrl: 'https://earthquake.usgs.gov/test'\n};\n\nDeno.test('FCMService - should send notification successfully', async () => {\n  // Note: This test requires valid FCM server key in environment\n  const result = await FCMService.sendNotification(testNotification);\n  \n  assertEquals(result.success, true);\n  assertExists(result.messageId);\n});\n\nDeno.test('FCMService - should handle FCM errors gracefully', async () => {\n  // Test with invalid server key\n  const originalKey = Deno.env.get('FCM_SERVER_KEY');\n  Deno.env.set('FCM_SERVER_KEY', 'invalid_key');\n  \n  const result = await FCMService.sendNotification(testNotification);\n  \n  assertEquals(result.success, false);\n  assertExists(result.error);\n  \n  // Restore original key\n  if (originalKey) {\n    Deno.env.set('FCM_SERVER_KEY', originalKey);\n  }\n});\n\nDeno.test('FCMService - should format notification payload correctly', async () => {\n  // Test internal payload formatting\n  const payload = FCMService.buildFCMPayload(testNotification);\n  \n  assertEquals(payload.to, '/topics/earthquake_alerts');\n  assertEquals(payload.notification.title.includes('4.5'), true);\n  assertEquals(payload.data.earthquake_id, 'test123');\n  assertEquals(payload.data.magnitude, '4.5');\n});\n```\n\n## End-to-End Tests\n\n### Complete System Flow Test\n\n**tests/e2e/earthquake-flow.test.ts**\n\n```typescript\nimport { assertEquals, assertExists } from 'https://deno.land/std@0.168.0/testing/asserts.ts';\n\nDeno.test('E2E - Complete earthquake monitoring flow', async () => {\n  console.log('ðŸ§ª Starting end-to-end test...');\n  \n  // Step 1: Test USGS API connection\n  console.log('ðŸ“¡ Testing USGS API...');\n  const usgsResponse = await fetch(\n    'https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&latitude=14.2919325&longitude=120.7752839&maxradiuskm=150'\n  );\n  assertEquals(usgsResponse.ok, true);\n  \n  const usgsData = await usgsResponse.json();\n  assertEquals(usgsData.type, 'FeatureCollection');\n  assertEquals(Array.isArray(usgsData.features), true);\n  \n  // Step 2: Test Edge Function\n  console.log('âš¡ Testing Edge Function...');\n  const functionResponse = await fetch(\n    'https://your-project.supabase.co/functions/v1/earthquake-monitor',\n    { method: 'POST' }\n  );\n  assertEquals(functionResponse.ok, true);\n  \n  const functionData = await functionResponse.json();\n  assertEquals(functionData.success, true);\n  assertExists(functionData.timestamp);\n  \n  // Step 3: Verify data was processed\n  console.log('ðŸ“Š Verifying data processing...');\n  if (functionData.new_earthquakes > 0) {\n    assertEquals(functionData.notifications_sent >= 0, true);\n    assertExists(functionData.earthquakes);\n  }\n  \n  console.log('âœ… End-to-end test completed successfully');\n});\n\nDeno.test('E2E - Test notification delivery', async () => {\n  // Send test notification to verify FCM setup\n  const testPayload = {\n    to: '/topics/earthquake_alerts',\n    notification: {\n      title: 'ðŸ§ª E2E Test Notification',\n      body: 'Testing earthquake notification system',\n      icon: 'earthquake_icon'\n    },\n    data: {\n      type: 'earthquake_alert',\n      test: 'true',\n      timestamp: Date.now().toString()\n    }\n  };\n  \n  const response = await fetch('https://fcm.googleapis.com/fcm/send', {\n    method: 'POST',\n    headers: {\n      'Authorization': `key=${Deno.env.get('FCM_SERVER_KEY')}`,\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify(testPayload)\n  });\n  \n  assertEquals(response.ok, true);\n  \n  const result = await response.json();\n  assertExists(result.message_id);\n});\n```\n\n## Performance Tests\n\n### Load Testing\n\n**tests/performance/load.test.ts**\n\n```typescript\nimport { assertEquals } from 'https://deno.land/std@0.168.0/testing/asserts.ts';\n\nDeno.test('Performance - USGS API response time', async () => {\n  const startTime = Date.now();\n  \n  const response = await fetch(\n    'https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&latitude=14.2919325&longitude=120.7752839&maxradiuskm=150'\n  );\n  \n  const endTime = Date.now();\n  const responseTime = endTime - startTime;\n  \n  assertEquals(response.ok, true);\n  assertEquals(responseTime < 10000, true); // Should respond within 10 seconds\n  \n  console.log(`ðŸ“ˆ USGS API response time: ${responseTime}ms`);\n});\n\nDeno.test('Performance - Edge Function execution time', async () => {\n  const startTime = Date.now();\n  \n  const response = await fetch(\n    'https://your-project.supabase.co/functions/v1/earthquake-monitor',\n    { method: 'POST' }\n  );\n  \n  const endTime = Date.now();\n  const executionTime = endTime - startTime;\n  \n  assertEquals(response.ok, true);\n  assertEquals(executionTime < 30000, true); // Should complete within 30 seconds\n  \n  console.log(`âš¡ Edge Function execution time: ${executionTime}ms`);\n});\n\nDeno.test('Performance - Concurrent notification sending', async () => {\n  const notifications = Array.from({ length: 10 }, (_, i) => ({\n    earthquakeId: `test_${i}`,\n    magnitude: 4.0 + i * 0.1,\n    location: `Test Location ${i}`,\n    coordinates: { latitude: 14.0, longitude: 120.0, depth: 10.0 },\n    time: Date.now(),\n    severity: 'light' as const,\n    priority: 'normal' as const,\n    tsunamiWarning: false\n  }));\n  \n  const startTime = Date.now();\n  \n  const promises = notifications.map(notification => \n    FCMService.sendNotification(notification)\n  );\n  \n  const results = await Promise.all(promises);\n  \n  const endTime = Date.now();\n  const totalTime = endTime - startTime;\n  \n  const successCount = results.filter(r => r.success).length;\n  assertEquals(successCount, notifications.length);\n  \n  console.log(`ðŸ“± Sent ${notifications.length} notifications in ${totalTime}ms`);\n});\n```\n\n## Mock Data and Test Utilities\n\n### Mock USGS Response\n\n**tests/mocks/usgs-response.ts**\n\n```typescript\nexport const mockUSGSResponse = {\n  type: 'FeatureCollection',\n  metadata: {\n    generated: Date.now(),\n    url: 'https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&latitude=14.2919325&longitude=120.7752839&maxradiuskm=150',\n    title: 'USGS Earthquakes',\n    status: 200,\n    api: '1.14.1',\n    count: 2\n  },\n  features: [\n    {\n      type: 'Feature',\n      properties: {\n        mag: 4.6,\n        place: '6 km NW of Test City, Philippines',\n        time: Date.now() - 300000, // 5 minutes ago\n        updated: Date.now() - 60000, // 1 minute ago\n        tz: null,\n        url: 'https://earthquake.usgs.gov/earthquakes/eventpage/test1',\n        detail: 'https://earthquake.usgs.gov/fdsnws/event/1/query?eventid=test1&format=geojson',\n        felt: null,\n        cdi: null,\n        mmi: null,\n        alert: null,\n        status: 'reviewed',\n        tsunami: 0,\n        sig: 326,\n        net: 'us',\n        code: 'test1',\n        ids: ',test1,',\n        sources: ',us,',\n        types: ',origin,phase-data,',\n        nst: 37,\n        dmin: 14.088,\n        rms: 0.91,\n        gap: 89,\n        magType: 'mb',\n        type: 'earthquake',\n        title: 'M 4.6 - 6 km NW of Test City, Philippines'\n      },\n      geometry: {\n        type: 'Point',\n        coordinates: [120.8377, 13.7424, 146.927]\n      },\n      id: 'test1'\n    },\n    {\n      type: 'Feature',\n      properties: {\n        mag: 5.2,\n        place: '12 km E of Another City, Philippines',\n        time: Date.now() - 600000, // 10 minutes ago\n        updated: Date.now() - 120000, // 2 minutes ago\n        tz: null,\n        url: 'https://earthquake.usgs.gov/earthquakes/eventpage/test2',\n        detail: 'https://earthquake.usgs.gov/fdsnws/event/1/query?eventid=test2&format=geojson',\n        felt: 25,\n        cdi: 4.2,\n        mmi: null,\n        alert: 'yellow',\n        status: 'reviewed',\n        tsunami: 0,\n        sig: 445,\n        net: 'us',\n        code: 'test2',\n        ids: ',test2,',\n        sources: ',us,',\n        types: ',origin,phase-data,felt,',\n        nst: 42,\n        dmin: 8.234,\n        rms: 0.76,\n        gap: 67,\n        magType: 'mb',\n        type: 'earthquake',\n        title: 'M 5.2 - 12 km E of Another City, Philippines'\n      },\n      geometry: {\n        type: 'Point',\n        coordinates: [121.1234, 14.5678, 85.432]\n      },\n      id: 'test2'\n    }\n  ]\n};\n\nexport const emptyUSGSResponse = {\n  type: 'FeatureCollection',\n  metadata: {\n    generated: Date.now(),\n    url: 'https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&latitude=14.2919325&longitude=120.7752839&maxradiuskm=150',\n    title: 'USGS Earthquakes',\n    status: 200,\n    api: '1.14.1',\n    count: 0\n  },\n  features: []\n};\n```\n\n### Test Utilities\n\n**tests/utils/test-helpers.ts**\n\n```typescript\nexport function createMockEarthquake(overrides: Partial<any> = {}) {\n  return {\n    id: 'mock_' + Math.random().toString(36).substring(7),\n    type: 'Feature',\n    properties: {\n      mag: 4.5,\n      place: 'Mock Location, Philippines',\n      time: Date.now(),\n      updated: Date.now(),\n      url: 'https://earthquake.usgs.gov/mock',\n      tsunami: 0,\n      status: 'reviewed',\n      title: 'M 4.5 - Mock Earthquake',\n      ...overrides.properties\n    },\n    geometry: {\n      type: 'Point',\n      coordinates: [120.0, 14.0, 10.0]\n    },\n    ...overrides\n  };\n}\n\nexport function createMockNotification(overrides: Partial<any> = {}) {\n  return {\n    earthquakeId: 'mock123',\n    magnitude: 4.5,\n    location: 'Mock Location, Philippines',\n    coordinates: { latitude: 14.0, longitude: 120.0, depth: 10.0 },\n    time: Date.now(),\n    severity: 'light' as const,\n    priority: 'normal' as const,\n    tsunamiWarning: false,\n    ...overrides\n  };\n}\n\nexport async function waitFor(condition: () => boolean, timeout: number = 5000): Promise<void> {\n  const startTime = Date.now();\n  \n  while (!condition() && Date.now() - startTime < timeout) {\n    await new Promise(resolve => setTimeout(resolve, 100));\n  }\n  \n  if (!condition()) {\n    throw new Error(`Condition not met within ${timeout}ms`);\n  }\n}\n\nexport function mockFetch(responseData: any, status: number = 200) {\n  const originalFetch = globalThis.fetch;\n  \n  globalThis.fetch = () => Promise.resolve(\n    new Response(JSON.stringify(responseData), { status })\n  );\n  \n  return () => {\n    globalThis.fetch = originalFetch;\n  };\n}\n```\n\n## Test Execution\n\n### Running Tests\n\n```bash\n# Run all tests\ndeno test --allow-net --allow-env tests/\n\n# Run specific test file\ndeno test --allow-net --allow-env tests/services/usgs.test.ts\n\n# Run tests with coverage\ndeno test --allow-net --allow-env --coverage=coverage tests/\ndeno coverage coverage --lcov > coverage.lcov\n\n# Run tests in watch mode\ndeno test --allow-net --allow-env --watch tests/\n\n# Run only unit tests\ndeno test --allow-net --allow-env tests/unit/\n\n# Run only integration tests\ndeno test --allow-net --allow-env tests/integration/\n\n# Run performance tests\ndeno test --allow-net --allow-env tests/performance/\n```\n\n### Test Configuration\n\n**deno.json**\n\n```json\n{\n  \"tasks\": {\n    \"test\": \"deno test --allow-net --allow-env tests/\",\n    \"test:unit\": \"deno test --allow-net --allow-env tests/unit/\",\n    \"test:integration\": \"deno test --allow-net --allow-env tests/integration/\",\n    \"test:e2e\": \"deno test --allow-net --allow-env tests/e2e/\",\n    \"test:performance\": \"deno test --allow-net --allow-env tests/performance/\",\n    \"test:coverage\": \"deno test --allow-net --allow-env --coverage=coverage tests/ && deno coverage coverage --lcov > coverage.lcov\",\n    \"test:watch\": \"deno test --allow-net --allow-env --watch tests/\"\n  },\n  \"test\": {\n    \"include\": [\"tests/\"],\n    \"exclude\": [\"tests/mocks/\"]\n  }\n}\n```\n\n## Continuous Integration\n\n### GitHub Actions Workflow\n\n**.github/workflows/test.yml**\n\n```yaml\nname: Test Earthquake System\n\non:\n  push:\n    branches: [ main, develop ]\n  pull_request:\n    branches: [ main ]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    \n    steps:\n    - uses: actions/checkout@v3\n    \n    - name: Setup Deno\n      uses: denoland/setup-deno@v1\n      with:\n        deno-version: v1.x\n    \n    - name: Cache dependencies\n      uses: actions/cache@v3\n      with:\n        path: ~/.cache/deno\n        key: ${{ runner.os }}-deno-${{ hashFiles('**/*.ts') }}\n    \n    - name: Run unit tests\n      run: deno task test:unit\n      env:\n        FCM_SERVER_KEY: ${{ secrets.FCM_SERVER_KEY }}\n        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}\n        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}\n    \n    - name: Run integration tests\n      run: deno task test:integration\n      env:\n        FCM_SERVER_KEY: ${{ secrets.FCM_SERVER_KEY }}\n        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}\n        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}\n    \n    - name: Generate coverage report\n      run: deno task test:coverage\n    \n    - name: Upload coverage to Codecov\n      uses: codecov/codecov-action@v3\n      with:\n        file: ./coverage.lcov\n```\n\n## Manual Testing Scenarios\n\n### 1. New Earthquake Detection\n\n**Test Steps:**\n1. Wait for a real earthquake to occur (or use test data)\n2. Verify Edge Function executes within 5 minutes\n3. Check notification is sent to mobile devices\n4. Verify earthquake data is saved to Firestore\n5. Confirm notification record is created\n\n**Expected Results:**\n- Function logs show successful execution\n- Mobile devices receive notification\n- Firestore contains new earthquake document\n- Notification collection has new record\n\n### 2. System Failure Recovery\n\n**Test Steps:**\n1. Temporarily disable FCM server key\n2. Trigger earthquake detection\n3. Verify system handles FCM failure gracefully\n4. Restore FCM server key\n5. Verify next cycle works normally\n\n**Expected Results:**\n- Error logged but system continues\n- Earthquake data still saved\n- Notification marked as failed\n- Subsequent notifications work\n\n### 3. High Magnitude Event\n\n**Test Steps:**\n1. Simulate magnitude 6.5+ earthquake\n2. Verify critical priority notification\n3. Check emergency alert features\n4. Confirm proper severity classification\n\n**Expected Results:**\n- High priority FCM notification\n- Critical alert styling\n- Proper severity level in data\n- Emergency contact notifications (if configured)\n\n## Test Data Management\n\n### Test Database Setup\n\n```typescript\n// Setup test Firestore instance\nexport async function setupTestDatabase() {\n  // Create test collections with sample data\n  const testEarthquakes = [\n    createMockEarthquake({ id: 'test_existing_1' }),\n    createMockEarthquake({ id: 'test_existing_2' })\n  ];\n  \n  await FirestoreService.saveNewEarthquakes(testEarthquakes);\n}\n\nexport async function cleanupTestDatabase() {\n  // Remove test data after tests\n  const testIds = ['test_existing_1', 'test_existing_2'];\n  \n  for (const id of testIds) {\n    await FirestoreService.deleteEarthquake(id);\n  }\n}\n```\n\n### Environment Variables for Testing\n\n```bash\n# .env.test\nFIREBASE_PROJECT_ID=your-test-project\nFCM_SERVER_KEY=test-server-key\nFIREBASE_SERVICE_ACCOUNT='{\"type\":\"service_account\",...}'\nUSGS_API_TIMEOUT=10000\nLOG_LEVEL=debug\n```\n\nThis comprehensive testing guide ensures your earthquake monitoring system is thoroughly tested at all levels, from individual functions to complete end-to-end workflows. Regular execution of these tests will help maintain system reliability in production.
````
